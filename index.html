<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>井字遊戲 - 智能 AI + 動畫 + 聲音</title>
  <style>
    :root{
      --cell-size: 12vmin; /* responsive base */
      --gap: 1.2vmin;
      --bg1:#0f172a; --bg2:#0b1220;
      --accent: #4f46e5;
    }
    html,body{height:100%;margin:0}
    body{
      font-family: Inter, Arial, "Noto Sans TC", sans-serif;
      min-height:100%;display:flex;flex-direction:column;align-items:center;justify-content:flex-start;
      color:#fff;background:linear-gradient(120deg,var(--bg1),var(--bg2));overflow-y:auto;
    }

    /* animated background using uploaded image (local path provided) */
    .bg-hero{
      position:fixed;inset:0;z-index:-2;background-size:cover;background-position:center;opacity:0.08;
      background-image: url('/mnt/data/22e0d0b3-ffa3-4d1c-ae4c-09f90237bbf0.png');
      filter: hue-rotate(200deg) blur(2px);
      animation: bgPan 30s linear infinite;
    }
    @keyframes bgPan{0%{transform:scale(1) translateX(0)}50%{transform:scale(1.05) translateX(-3%)}100%{transform:scale(1) translateX(0)}}

    header{padding:28px 16px 6px;text-align:center}
    h1{margin:0;font-size:clamp(18px,3.6vmin,34px);letter-spacing:0.4px}
    .meta{margin-top:8px;color:rgba(255,255,255,0.7);font-size:0.9rem}

    main{width:100%;max-width:920px;padding:18px;box-sizing:border-box;display:flex;gap:24px;align-items:flex-start;justify-content:center}

    /* board area */
    .game-wrap{background:linear-gradient(180deg,rgba(255,255,255,0.03),rgba(255,255,255,0.01));padding:18px;border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6);backdrop-filter: blur(6px);}

    #board{display:grid;grid-template-columns:repeat(3, var(--cell-size));gap:var(--gap);}
    .cell{width:var(--cell-size);height:var(--cell-size);display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#0f172a33,#ffffff05);border-radius:10px;font-size:calc(var(--cell-size)*0.55);cursor:pointer;user-select:none;transition:transform .18s ease, box-shadow .18s ease, background .18s ease;box-shadow:0 6px 18px rgba(2,6,23,0.5);}
    .cell:hover{transform:translateY(-6px) scale(1.02);box-shadow:0 18px 30px rgba(2,6,23,0.6)}
    .cell.win{background:linear-gradient(90deg,#ffecb3,#ffd54f);color:#111;transform:scale(1.06) !important}

    /* control panel */
    .panel{display:flex;flex-direction:column;gap:12px;padding:12px;min-width:220px}
    .panel .status{font-size:1.05rem}
    .btn{padding:10px 14px;border-radius:10px;border:0;cursor:pointer;font-weight:600}
    .btn.primary{background:var(--accent);color:#fff}
    .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.08);color:#fff}

    .stats{display:flex;gap:8px;flex-wrap:wrap}
    .stat{padding:8px 12px;background:rgba(255,255,255,0.03);border-radius:10px}

    footer{color:rgba(255,255,255,0.6);font-size:12px;padding:22px}

    /* responsive */
    @media (max-width:600px){
      :root{--cell-size:20vmin}
      main{flex-direction:column;align-items:center}
      .panel{width:100%;align-items:center}
    }

    /* simple appear animation */
    .fade-in{animation:fadeIn .45s ease both}
    @keyframes fadeIn{from{opacity:0;transform:translateY(6px)}to{opacity:1;transform:none}}
  </style>
</head>
<body>
  <div class="bg-hero" aria-hidden></div>
  <header>
    <h1>井字遊戲 — 智能 AI + 動畫 + 聲音</h1>
    <div class="meta">玩家 X 對電腦 O（AI 使用 Minimax），結果會記錄於本機。</div>
  </header>

  <main>
    <section class="game-wrap fade-in">
      <div id="board" aria-label="井字棋棋盤"></div>
      <div style="display:flex;justify-content:center;margin-top:12px;gap:8px">
        <button class="btn primary" id="restart">重新開始</button>
        <button class="btn ghost" id="undo">悔棋</button>
      </div>
    </section>

    <aside class="panel fade-in">
      <div class="status" id="status">輪到: <strong id="turn">X</strong></div>

      <div class="stats">
        <div class="stat">玩家勝: <span id="wins">0</span></div>
        <div class="stat">電腦勝: <span id="losses">0</span></div>
        <div class="stat">平手: <span id="draws">0</span></div>
      </div>

      <div style="margin-top:10px;display:flex;gap:8px">
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="soundToggle" checked> 音效</label>
        <label style="display:flex;align-items:center;gap:6px"><input type="checkbox" id="aiToggle" checked> AI 開啟</label>
      </div>

      <div style="margin-top:12px;font-size:0.92rem;color:rgba(255,255,255,0.85)">說明：點擊格子下 X；電腦會用最佳步驟回手。可使用悔棋（只限最近一步）。</div>
    </aside>
  </main>

  <footer>儲存在 localStorage 中 • 如需重置統計請在瀏覽器清除儲存</footer>

  <script>
    /* --- Game state --- */
    const boardEl = document.getElementById('board');
    const statusEl = document.getElementById('status');
    const turnEl = document.getElementById('turn');
    const restartBtn = document.getElementById('restart');
    const undoBtn = document.getElementById('undo');
    const winsEl = document.getElementById('wins');
    const lossesEl = document.getElementById('losses');
    const drawsEl = document.getElementById('draws');
    const soundToggle = document.getElementById('soundToggle');
    const aiToggle = document.getElementById('aiToggle');

    let board = Array(9).fill('');
    let currentPlayer = 'X';
    let gameActive = true;
    let history = []; // for undo

    /* stats */
    const statsKey = 'ttt_stats_v1';
    let stats = {wins:0, losses:0, draws:0};
    try{const s = localStorage.getItem(statsKey); if(s) stats = JSON.parse(s);}catch(e){}
    updateStatsUI();

    function saveStats(){ localStorage.setItem(statsKey, JSON.stringify(stats)); updateStatsUI(); }
    function updateStatsUI(){ winsEl.textContent = stats.wins; lossesEl.textContent = stats.losses; drawsEl.textContent = stats.draws; }

    /* --- Sound (generated via WebAudio) --- */
    const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    function playBeep(frequency=440,duration=0.08, type='sine', gain=0.06){ if(!soundToggle.checked) return; const o = audioCtx.createOscillator(); const g = audioCtx.createGain(); o.type = type; o.frequency.value = frequency; g.gain.value = gain; o.connect(g); g.connect(audioCtx.destination); o.start(); g.gain.exponentialRampToValueAtTime(0.0001, audioCtx.currentTime + duration); setTimeout(()=>o.stop(), duration*1000); }
    function playWin(){ playBeep(660,0.18,'sawtooth',0.09); setTimeout(()=>playBeep(880,0.18,'sine',0.11),160); }
    function playPlace(){ playBeep(520,0.06,'sine',0.06); }
    function playDraw(){ playBeep(320,0.14,'triangle',0.06); }

    /* --- Render --- */
    function render(){ boardEl.innerHTML = ''; board.forEach((v,i)=>{
      const d = document.createElement('div'); d.className='cell'; d.dataset.i=i; d.textContent=v; d.addEventListener('click',()=>onCellClick(i)); boardEl.appendChild(d);
    }); turnEl.textContent = currentPlayer; }

    /* --- Game logic (win check) --- */
    const winCombos = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
    function checkWinner(b=board){ for(const [a,b1,c] of winCombos){ if(b[a] && b[a]===b[b1] && b[a]===b[c]) return {winner:b[a],combo:[a,b1,c]}; } if(!b.includes('')) return {winner:'draw'}; return null; }

    /* --- Minimax AI (O is AI) --- */
    function minimax(bd, player){ const res = checkWinner(bd); if(res){ if(res.winner==='X') return {score:-10}; if(res.winner==='O') return {score:10}; if(res.winner==='draw') return {score:0}; }
      const moves = [];
      for(let i=0;i<9;i++){
        if(bd[i]===''){ const move={index:i}; bd[i]=player; const result = minimax(bd, player==='O'?'X':'O'); move.score = result.score; bd[i]=''; moves.push(move); }
      }
      let bestMove;
      if(player==='O'){ let bestScore=-Infinity; for(const m of moves){ if(m.score>bestScore){bestScore=m.score;bestMove=m;} } return bestMove; }
      else { let bestScore=Infinity; for(const m of moves){ if(m.score<bestScore){bestScore=m.score;bestMove=m;} } return bestMove; }
    }

    /* --- UI helpers --- */
    function highlightWinning(combo){ const cells = document.querySelectorAll('.cell'); combo.forEach(i=>cells[i].classList.add('win')); }

    /* --- Actions --- */
    function onCellClick(i){ if(!gameActive || board[i]!=='' ) return; history.push(board.slice()); board[i]=currentPlayer; animatePlace(i); playPlace(); const res = checkWinner(); if(res){ endGame(res); return; } if(aiToggle.checked){ currentPlayer='O'; render(); // AI move using minimax with small delay
        setTimeout(()=>{ const best = minimax(board.slice(),'O'); const moveIndex = best?best.index:board.findIndex(x=>x===''); if(moveIndex>=0){ history.push(board.slice()); board[moveIndex]='O'; animatePlace(moveIndex); playPlace(); const r2 = checkWinner(); if(r2){ endGame(r2); } currentPlayer='X'; render(); } }, 220);
      } else { currentPlayer='O'; render(); }

      render(); }

    function animatePlace(i){ const cell = boardEl.querySelector(`.cell[data-i="${i}"]`); if(!cell) return; cell.animate([{transform:'scale(0.6)'},{transform:'scale(1.05)'},{transform:'scale(1)'}],{duration:260,easing:'cubic-bezier(.2,.9,.3,1)'}); }

    function endGame(result){ gameActive=false; if(result.winner==='draw'){ statusEl.textContent='平手！'; playDraw(); stats.draws+=1; saveStats(); } else { statusEl.textContent = result.winner+' 勝利！'; highlightWinning(result.combo); playWin(); if(result.winner==='X') stats.wins+=1; else stats.losses+=1; saveStats(); } }

    restartBtn.addEventListener('click',()=>{ restartGame(); });
    undoBtn.addEventListener('click',()=>{ if(history.length>0 && gameActive){ board = history.pop(); currentPlayer = 'X'; render(); } });

    function restartGame(){ board = Array(9).fill(''); history=[]; currentPlayer='X'; gameActive=true; statusEl.textContent=''; // reset win highlight
      const cells = document.querySelectorAll('.cell'); cells.forEach(c=>c.classList.remove('win')); render(); }

    /* expose a function to reset stats if needed (console) */
    window.resetTttStats = ()=>{ stats={wins:0,losses:0,draws:0}; saveStats(); }

    /* init */
    render();

    // Auto-play AI first move if O starts (not used) -- kept for extensibility
  </script>
</body>
</html>
